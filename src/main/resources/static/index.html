<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resume Creator</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Cropper.js CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <style>
        .form-section {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .education-item,
        .experience-item,
        .skill-item,
        .link-item {
            margin-bottom: 10px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        #photo-card {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        #photo-card img {
            object-fit: cover;
            height: 200px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 class="mt-5">Resume Creator</h1>

        <!-- Personal Information Section -->
        <div id="personal-info-section" class="form-section position-relative">
            <h2>Personal Information</h2>
            <button type="button" class="btn btn-success mb-3" id="add-personal-info-btn">+ Add Personal
                Information</button>
            <form id="resume-form" class="d-none" enctype="multipart/form-data">
                <div class="row">
                    <!-- Panel for Name, Email, Phone, and Summary -->
                    <div class="col-md-8">
                        <div class="card p-3">
                            <div class="form-group">
                                <label for="name">Name</label>
                                <input type="text" class="form-control" id="name" required>
                            </div>
                            <div class="form-group">
                                <label for="email">Email</label>
                                <input type="email" class="form-control" id="email" required>
                            </div>
                            <div class="form-group">
                                <label for="phone">Phone</label>
                                <input type="text" class="form-control" id="phone" required>
                            </div>
                            <div class="form-group">
                                <label for="summary">Profile</label>
                                <textarea class="form-control" id="summary" rows="5" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="currentPosition">Current position name</label>
                                <input type="text" class="form-control" id="currentPosition" required>
                            </div>
                        </div>
                    </div>
                    <!-- Panel for Photo -->
                    <div class="col-md-4">
                        <div id="photo-card" class="card text-center p-3"
                            style="border: 2px dashed #ddd; cursor: pointer;">
                            <div id="photo-placeholder" class="d-flex flex-column align-items-center">
                                <i class="fas fa-user-circle fa-3x text-muted"></i>
                                <span class="text-muted mt-2">Click to upload your photo</span>
                            </div>
                            <input type="file" class="form-control-file d-none" id="photo" accept="image/*">
                            <img id="photo-preview" src="#" alt="Photo Preview" class="img-thumbnail mt-3 d-none"
                                style="width: 132px; height: 170px;">
                        </div>
                    </div>
                    <!-- Crop Modal -->
                    <div class="modal fade" id="cropModal" tabindex="-1" role="dialog" aria-labelledby="cropModalLabel"
                        aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered modal-sm" role="document"
                            style="max-width: 400px;">
                            <div class="modal-content">
                                <div class="modal-header py-2">
                                    <h5 class="modal-title" id="cropModalLabel">Crop Your Photo</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"
                                        id="closeCropModalBtn"></button>
                                </div>
                                <div class="modal-body d-flex justify-content-center align-items-center"
                                    style="min-height: 320px;">
                                    <div class="w-100" style="max-height: 300px; overflow: hidden;">
                                        <img id="image-to-crop" class="img-fluid"
                                            style="max-width: 100%; height: auto; display: block; margin: 0 auto;" />
                                    </div>
                                </div>
                                <div class="modal-footer justify-content-center">
                                    <button type="button" id="cropImageBtn" class="btn btn-primary">Crop & Use</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- End of Crop Modal -->
                </div>
                <button type="submit" class="btn btn-primary mt-3">Save Personal Information</button>
            </form>
        </div>

        <!-- Education Section -->
        <div id="education-section" class="form-section">
            <h2>Education</h2>
            <button type="button" class="btn btn-success mb-3" id="add-education-btn">+ Add Education</button>
            <form id="education-form" class="d-none">
                <div class="form-group">
                    <label for="institution">Institution</label>
                    <input type="text" class="form-control" id="institution" required>
                </div>
                <div class="form-group">
                    <label for="degree">Degree</label>
                    <input type="text" class="form-control" id="degree" required>
                </div>
                <div class="form-group">
                    <label for="startDateEdu">Start Date</label>
                    <input type="date" class="form-control" id="startDateEdu" required>
                </div>
                <div class="form-group">
                    <label for="endDateEdu">End Date</label>
                    <input type="date" class="form-control" id="endDateEdu">
                </div>
                <div class="form-group">
                    <label for="descriptionEdu">Description</label>
                    <textarea class="form-control" id="descriptionEdu" rows="2"></textarea>
                </div>
                <button type="button" class="btn btn-success add-education">Add Education</button>
            </form>
            <div id="education-list"></div>
        </div>

        <!-- Experience Section -->
        <div id="experience-section" class="form-section">
            <h2>Experience</h2>
            <button type="button" class="btn btn-success mb-3" id="add-experience-btn">+ Add Experience</button>
            <form id="experience-form" class="d-none">
                <div class="form-group">
                    <label for="company">Company</label>
                    <input type="text" class="form-control" id="company" required>
                </div>
                <div class="form-group">
                    <label for="jobTitle">Job Title</label>
                    <input type="text" class="form-control" id="jobTitle" required>
                </div>
                <div class="form-group">
                    <label for="startDateExp">Start Date</label>
                    <input type="date" class="form-control" id="startDateExp" required>
                </div>
                <div class="form-group">
                    <label for="endDateExp">End Date</label>
                    <input type="date" class="form-control" id="endDateExp">
                </div>
                <div class="form-group">
                    <label for="descriptionExp">Description</label>
                    <textarea class="form-control" id="descriptionExp" rows="2"></textarea>
                </div>
                <button type="button" class="btn btn-success add-experience">Add Experience</button>
            </form>
            <div id="experience-list"></div>
        </div>

        <!-- Skills Section -->
        <div id="skills-section" class="form-section">
            <h2>Skills</h2>
            <button type="button" class="btn btn-success mb-3" id="add-skill-btn">+ Add Skill</button>
            <form id="skills-form" class="d-none">
                <div class="form-group">
                    <label for="title">Title</label>
                    <input type="text" class="form-control" id="title" required>
                </div>
                <div class="form-group">
                    <label for="skillName">Skill Name</label>
                    <input type="text" class="form-control" id="skillName" required>
                </div>
                <button type="button" class="btn btn-success add-skill">Add Skill</button>
            </form>
            <div id="skills-list"></div>
        </div>
        <!-- Links Section -->
        <div id="links-section" class="form-section">
            <h2>Links</h2>
            <button type="button" class="btn btn-success mb-3" id="add-link-btn">+ Add Link</button>
            <form id="links-form" class="d-none">
                <div class="form-group">
                    <label for="url">Url</label>
                    <input type="text" class="form-control" id="url" required>
                </div>
                <div class="form-group">
                    <label for="description">Description</label>
                    <input type="text" class="form-control" id="description" required>
                </div>
                <button type="button" class="btn btn-success add-link">Add link</button>
            </form>
            <div id="links-list"></div>
        </div>
        <div id="resumes" class="mt-5"></div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <!-- Cropper.js JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script>
        let cropper;
        let selectedFile;
        let croppedBlob = null;

        $(document).ready(function () {
            // Toggle Personal Information Form
            $('#add-personal-info-btn').click(function () {
                $('#resume-form').toggleClass('d-none');
            });

            // Toggle Education Form
            $('#add-education-btn').click(function () {
                $('#education-form').toggleClass('d-none');
            });

            // Toggle Experience Form
            $('#add-experience-btn').click(function () {
                $('#experience-form').toggleClass('d-none');
            });

            // Toggle Skills Form
            $('#add-skill-btn').click(function () {
                $('#skills-form').toggleClass('d-none');
            });

            // Toggle Links Form
            $('#add-link-btn').click(function () {
                $('#links-form').toggleClass('d-none');
            });

            const apiUrl = '/api/resumes';
            const saveUrl = '/api/resumes/create';
            let currentResumeId = null;

            // Function to fetch and display resumes
            function fetchResumes() {
                $.get(apiUrl, function (data) {
                    let resumesHtml = '';
                    data.forEach(resume => {
                        resumesHtml += `<div class="card mt-3">
                            <div class="card-body">
                                <h5 class="card-title">${resume.name}</h5>
                                <p class="card-text">Email: ${resume.email}</p>
                                <p class="card-text">Phone: ${resume.phone}</p>
                                <p class="card-text">Summary: ${resume.summary}</p>
                                <p class="card-text">Current Position: ${resume.currentPosition}</p>
                                <button class="btn btn-info view-details" data-resume-id="${resume.id}">View Details</button>
                                <button type="button" class="btn btn-primary mt-3 download-pdf-btn" data-resume-id="${resume.id}">Download PDF</button>
                            </div>
                        </div>`;
                    });
                    $('#resumes').html(resumesHtml);

                    // Attach click event to "View Details" buttons
                    $('.view-details').click(function () {
                        const resumeId = $(this).data('resume-id');
                        currentResumeId = resumeId;
                        fetchResumeDetails(resumeId);
                    });
                });
            }

            // Function to fetch and display resume details
            function fetchResumeDetails(resumeId) {
                $.get(`${apiUrl}/${resumeId}`, function (resume) {
                    // Populate personal information
                    $('#name').val(resume.name);
                    $('#email').val(resume.email);
                    $('#phone').val(resume.phone);
                    $('#summary').val(resume.summary);
                    $('#currentPosition').val(resume.currentPosition) || 'None';
                    // Populate photo if available
                    if (resume.photo) {
                        $('#photo-placeholder').addClass('d-none');
                        $('#photo-preview')
                            .attr('src', `data:image/jpeg;base64,${resume.photo}`)
                            .removeClass('d-none');
                    } else {
                        $('#photo-placeholder').removeClass('d-none');
                        $('#photo-preview').addClass('d-none').attr('src', '#');
                    }

                    // Clear and populate education, experience, and skills sections
                    $('#education-list').html('');
                    resume.educations.forEach(edu => {
                        $('#education-list').append(`
                            <div class="education-item d-flex justify-content-between align-items-center" data-id="${edu.id}">
                                <p class="mb-0">${edu.institution} - ${edu.degree} (${edu.startDate} to ${edu.endDate})</p>
                                <button class="btn btn-danger btn-sm remove-education" data-id="${edu.id}">- Remove</button>
                            </div>`);
                    });

                    $('#experience-list').html('');
                    resume.experiences.forEach(exp => {
                        $('#experience-list').append(`
                            <div class="experience-item d-flex justify-content-between align-items-center" data-id="${exp.id}">
                                <p class="mb-0">${exp.company} - ${exp.jobTitle} (${exp.startDate} to ${exp.endDate})</p>
                                <button class="btn btn-danger btn-sm remove-experience" data-id="${exp.id}">- Remove</button>
                            </div>`);
                    });

                    $('#skills-list').html('');
                    resume.skills.forEach(skill => {
                        $('#skills-list').append(`
                            <div class="skill-item d-flex justify-content-between align-items-center" data-id="${skill.id}">
                                <p class="mb-0">${skill.title} - ${skill.name}</p>
                                <button class="btn btn-danger btn-sm remove-skill" data-id="${skill.id}">- Remove</button>
                            </div>`);
                    });


                    $('#links-list').html('');
                    resume.links.forEach(link => {
                        $('#links-list').append(`
                            <div class="link-item d-flex justify-content-between align-items-center" data-id="${link.id}">
                                <p class="mb-0">${link.description} - ${link.url} </p>
                                <button class="btn btn-danger btn-sm remove-link" data-id="${link.id}">- Remove</button>
                            </div>`);
                    });

                    alert('Resume details loaded. You can now add more information.');
                });
            }

            // Handle personal information form submission
            $('#resume-form').submit(function (event) {
                event.preventDefault();
                const formData = new FormData();
                formData.append('name', $('#name').val());
                formData.append('email', $('#email').val());
                formData.append('phone', $('#phone').val());
                formData.append('summary', $('#summary').val());
                formData.append('currentPosition', $('#currentPosition').val() || 'None');

                // Append cropped photo if available
                if (croppedBlob) {
                    formData.append('photo', croppedBlob, 'cropped-photo.png');
                }

                const url = currentResumeId ? `/api/resumes/${currentResumeId}/update` : saveUrl;
                const method = currentResumeId ? 'PUT' : 'POST';

                $.ajax({
                    type: method,
                    url: url,
                    data: formData,
                    processData: false,
                    contentType: false, // Ensure multipart/form-data is used
                    success: function (updatedResume) {
                        currentResumeId = updatedResume.id;
                        fetchResumes();

                        // Reset personal information form
                        $('#resume-form')[0].reset();
                        $('#photo-placeholder').removeClass('d-none');
                        $('#photo-preview').addClass('d-none').attr('src', '#');
                        alert('Personal information saved successfully!');
                    },
                    error: function () {
                        alert('Error saving personal information.');
                    }
                });
            });

            // Handle education form submission
            $('.add-education').click(function () {
                if (!currentResumeId) {
                    alert('Please save personal information first.');
                    return;
                }

                const education = {
                    institution: $('#institution').val(),
                    degree: $('#degree').val(),
                    startDate: $('#startDateEdu').val(),
                    endDate: $('#endDateEdu').val(),
                    description: $('#descriptionEdu').val()
                };

                $.ajax({
                    type: 'POST',
                    url: `/api/resumes/${currentResumeId}/educations`,
                    contentType: 'application/json',
                    data: JSON.stringify(education),
                    success: function (newEducation) {
                        const educationHtml = `
                            <div class="education-item d-flex justify-content-between align-items-center" data-id="${newEducation.id}">
                                <p class="mb-0">${newEducation.institution} - ${newEducation.degree} (${newEducation.startDate} to ${newEducation.endDate})</p>
                                <button class="btn btn-danger btn-sm remove-education" data-id="${newEducation.id}">- Remove</button>
                            </div>`;
                        $('#education-list').append(educationHtml);

                        // Reset education form
                        $('#education-form')[0].reset();
                        alert('Education added successfully!');
                    },
                    error: function () {
                        alert('Error adding education.');
                    }
                });
            });

            $('#education-list').on('click', '.remove-education', function () {
                const educationId = $(this).data('id');
                $.ajax({
                    type: 'DELETE',
                    url: `/api/resumes/educations/${educationId}`,
                    success: function () {
                        $(`.education-item[data-id="${educationId}"]`).remove();
                        alert('Education removed successfully!');
                    },
                    error: function () {
                        alert('Error removing education.');
                    }
                });
            });

            // Handle experience form submission
            $('.add-experience').click(function () {
                if (!currentResumeId) {
                    alert('Please save personal information first.');
                    return;
                }

                const experience = {
                    company: $('#company').val(),
                    jobTitle: $('#jobTitle').val(),
                    startDate: $('#startDateExp').val(),
                    endDate: $('#endDateExp').val(),
                    description: $('#descriptionExp').val()
                };

                $.ajax({
                    type: 'POST',
                    url: `/api/resumes/${currentResumeId}/experiences`,
                    contentType: 'application/json',
                    data: JSON.stringify(experience),
                    success: function (newExperience) {
                        const experienceHtml = `
                            <div class="experience-item d-flex justify-content-between align-items-center" data-id="${newExperience.id}">
                                <p class="mb-0">${newExperience.company} - ${newExperience.jobTitle} (${newExperience.startDate} to ${newExperience.endDate})</p>
                                <button class="btn btn-danger btn-sm remove-experience" data-id="${newExperience.id}">- Remove</button>
                            </div>`;
                        $('#experience-list').append(experienceHtml);

                        // Reset experience form
                        $('#experience-form')[0].reset();
                        alert('Experience added successfully!');
                    },
                    error: function () {
                        alert('Error adding experience.');
                    }
                });
            });

            $('#experience-list').on('click', '.remove-experience', function () {
                const experienceId = $(this).data('id');
                $.ajax({
                    type: 'DELETE',
                    url: `/api/resumes/experiences/${experienceId}`,
                    success: function () {
                        $(`.experience-item[data-id="${experienceId}"]`).remove();
                        alert('Experience removed successfully!');
                    },
                    error: function () {
                        alert('Error removing experience.');
                    }
                });
            });

            // Handle skills form submission
            $('.add-skill').click(function () {
                if (!currentResumeId) {
                    alert('Please save personal information first.');
                    return;
                }

                const skill = {
                    title: $('#title').val(),
                    name: $('#skillName').val()
                };

                $.ajax({
                    type: 'POST',
                    url: `/api/resumes/${currentResumeId}/skills`,
                    contentType: 'application/json',
                    data: JSON.stringify(skill),
                    success: function (newSkill) {
                        const skillHtml = `
                            <div class="skill-item d-flex justify-content-between align-items-center" data-id="${newSkill.id}">
                                <p class="mb-0">${newSkill.title}</p>
                                <p class="mb-0">${newSkill.name}</p>
                                <button class="btn btn-danger btn-sm remove-skill" data-id="${newSkill.id}">- Remove</button>
                            </div>`;
                        $('#skills-list').append(skillHtml);

                        // Reset skills form
                        $('#skills-form')[0].reset();
                        alert('Skill added successfully!');
                    },
                    error: function () {
                        alert('Error adding skill.');
                    }
                });
            });

            $('#skills-list').on('click', '.remove-skill', function () {
                const skillId = $(this).data('id');
                $.ajax({
                    type: 'DELETE',
                    url: `/api/resumes/skills/${skillId}`,
                    success: function () {
                        $(`.skill-item[data-id="${skillId}"]`).remove();
                        alert('Skill removed successfully!');
                    },
                    error: function () {
                        alert('Error removing skill.');
                    }
                });
            });

            // Handle links form submission
            $('.add-link').click(function () {
                if (!currentResumeId) {
                    alert('Please save personal information first.');
                    return;
                }

                const link = {
                    url: $('#url').val(),
                    description: $('#description').val()
                };

                $.ajax({
                    type: 'POST',
                    url: `/api/resumes/${currentResumeId}/links`,
                    contentType: 'application/json',
                    data: JSON.stringify(link),
                    success: function (newLink) {
                        const linkHtml = `
                            <div class="link-item d-flex justify-content-between align-items-center" data-id="${newLink.id}">
                                <p class="mb-0">${newLink.description}</p>
                                <p class="mb-0">${newLink.url}</p>
                                <button class="btn btn-danger btn-sm remove-link" data-id="${newLink.id}">- Remove</button>
                            </div>`;
                        $('#links-list').append(linkHtml);

                        // Reset skills form
                        $('#links-form')[0].reset();
                        alert('Link added successfully!');
                    },
                    error: function () {
                        alert('Error adding link.');
                    }
                });
            });

            $('#links-list').on('click', '.remove-link', function () {
                const linkId = $(this).data('id');
                if (!linkId) {
                    alert('Invalid link ID.');
                    return;
                }
                $.ajax({
                    type: 'DELETE',
                    url: `/api/resumes/links/${linkId}`,
                    success: function () {
                        $(`.link-item[data-id="${linkId}"]`).remove();
                        alert('Link removed successfully!');
                    },
                    error: function (xhr) {
                        const errorMessage = xhr.responseJSON?.message || 'Error removing link.';
                        alert(errorMessage);
                    }
                });
            });

            // Attach click event to dynamically created "Download PDF" 
            $('#resumes').on('click', '.download-pdf-btn', function () {
                const resumeId = $(this).data('resume-id');
                $.get(`${apiUrl}/${resumeId}`, function (resume) {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const pageHeight = 297;
                    const leftWidth = 60;
                    const rightX = leftWidth + 10;
                    let leftY = 10;
                    let rightY = 20;

                    // Set default font for non-title text
                    doc.setFont('Aileron', 'normal');
                    doc.setFontSize(10);

                    // Helper: adds a new page, resets positions, and draws the left panel background.
                    function addNewPage() {
                        doc.addPage();
                        leftY = 10;
                        rightY = 20;
                        // Draw left panel background for new page
                        doc.setFillColor(240, 240, 240);
                        doc.rect(0, 0, leftWidth, pageHeight, 'F');
                        // Reset default font for non-title text on new page
                        doc.setFont('Aileron', 'normal');
                        doc.setFontSize(10);
                    }

                    // Draw left panel background on the first page
                    doc.setFillColor(240, 240, 240);
                    doc.rect(0, 0, leftWidth, pageHeight, 'F');

                    // ====== LEFT PANEL: PHOTO + CONTACT ======
                    if (resume.photo) {
                        const imgData = `data:image/jpeg;base64,${resume.photo}`;
                        doc.addImage(imgData, 'JPEG', 10, leftY, 40, 40);
                        leftY += 50;
                    }
                    // Contact Title (bold, size 12)
                    doc.setFont('Aileron', 'bold');
                    doc.setFontSize(12);
                    doc.text("Contact", 10, leftY);
                    leftY += 4;
                    doc.setLineWidth(0.2);
                    doc.line(10, leftY, leftWidth - 10, leftY);
                    leftY += 5;
                    // Contact details (normal, size 10)
                    doc.setFont('Aileron', 'normal');
                    doc.setFontSize(10);
                    doc.text(`Name: ${resume.name}`, 10, leftY);
                    leftY += 5;
                    doc.text(`Email: ${resume.email}`, 10, leftY);
                    leftY += 5;
                    doc.text(`Phone: ${resume.phone}`, 10, leftY);
                    leftY += 10;

                    if (leftY > 280 || rightY > 280) { addNewPage(); }

                    // ====== LEFT PANEL: EDUCATION ======
                    doc.setFont('Aileron', 'bold');
                    doc.setFontSize(12);
                    doc.text("Education", 10, leftY);
                    leftY += 4;
                    doc.line(10, leftY, leftWidth - 10, leftY);
                    leftY += 5;
                    doc.setFont('Aileron', 'normal');
                    doc.setFontSize(10);
                    if (resume.educations.length > 0) {
                        resume.educations.forEach((edu) => {
                            const textLines = doc.splitTextToSize(`${edu.institution}`, leftWidth - 20);
                            textLines.forEach(line => {
                                if (leftY >= 280 || rightY >= 280) { addNewPage(); }
                                doc.text(line, 10, leftY);
                                leftY += 5;
                            });
                            if (leftY >= 280 || rightY >= 280) { addNewPage(); }
                            doc.text(`${edu.degree}`, 10, leftY);
                            leftY += 5;
                            doc.text(`${edu.startDate} - ${edu.endDate}`, 10, leftY);
                            leftY += 8;
                        });
                    } else {
                        doc.text("No education added.", 10, leftY);
                        leftY += 10;
                    }

                    // ====== LEFT PANEL: TECHNICAL SKILLS ======
                    if (resume.skills && resume.skills.length > 0) {
                        doc.setFont('Aileron', 'bold');
                        doc.setFontSize(12);
                        doc.text("Technical Skills", 10, leftY);
                        leftY += 4;
                        doc.line(10, leftY, leftWidth - 10, leftY);
                        leftY += 5;
                        doc.setFont('Aileron', 'normal');
                        doc.setFontSize(10);
                        resume.skills.forEach((skill) => {
                            const skillLines = doc.splitTextToSize(`${skill.title}: ${skill.name}`, leftWidth - 20);
                            skillLines.forEach(line => {
                                if (leftY >= 280 || rightY >= 280) { addNewPage(); }
                                doc.text(`â€¢ ${line}`, 10, leftY);
                                leftY += 5;
                            });
                        });
                    }

                    // ====== LEFT PANEL: SOCIAL LINKS ======
                    if (resume.links && resume.links.length > 0) {
                        doc.setFont('Aileron', 'bold');
                        doc.setFontSize(12);
                        doc.text("Social Links", 10, leftY);
                        leftY += 4;
                        doc.line(10, leftY, leftWidth - 10, leftY);
                        leftY += 5;
                        doc.setFont('Aileron', 'normal');
                        doc.setFontSize(10);
                        resume.links.forEach((link) => {
                            // Option 1: Print as text (non-clickable)
                            const linkText = `${link.description}: ${link.url}`;
                            const textLines = doc.splitTextToSize(linkText, leftWidth - 20);
                            textLines.forEach(line => {
                                if (leftY >= 280 || rightY >= 280) { addNewPage(); }
                                doc.text(line, 10, leftY);
                                leftY += 5;
                            });

                            // Option 2: Uncomment below to add clickable links (if supported)
                            // if (leftY >= 280 || rightY >= 280) { addNewPage(); }
                            // doc.textWithLink(`${link.description}`, 10, leftY, { url: link.url });
                            // leftY += 5;
                        });
                    }

                    // ====== RIGHT PANEL: SUMMARY ======
                    doc.setFont('Aileron', 'bold');
                    doc.setFontSize(18);
                    doc.text('Resume', rightX, rightY);
                    rightY += 10;

                    doc.setFont('Aileron', 'bold');
                    doc.setFontSize(12);
                    doc.text('Summary', rightX, rightY);
                    doc.setLineWidth(0.2);
                    doc.line(rightX, rightY + 1, 200, rightY + 1);
                    rightY += 6;
                    doc.setFont('Aileron', 'normal');
                    doc.setFontSize(10);
                    const summaryLines = doc.splitTextToSize(resume.summary, 130);
                    if (rightY + summaryLines.length * 6 > 280) { addNewPage(); }
                    doc.text(summaryLines, rightX, rightY);
                    rightY += summaryLines.length * 6 + 4;

                    // ====== RIGHT PANEL: EXPERIENCE ======
                    doc.setFont('Aileron', 'bold');
                    doc.setFontSize(12);
                    doc.text('Experience', rightX, rightY);
                    doc.line(rightX, rightY + 1, 200, rightY + 1);
                    rightY += 6;
                    doc.setFont('Aileron', 'normal');
                    doc.setFontSize(10);
                    if (resume.experiences.length > 0) {
                        resume.experiences.forEach((exp) => {
                            const header = `${exp.company} - ${exp.jobTitle} (${exp.startDate} to ${exp.endDate})`;
                            const headerLines = doc.splitTextToSize(header, 130);
                            const descriptionLines = doc.splitTextToSize(exp.description || '', 130);

                            if (rightY + headerLines.length * 6 > 280) { addNewPage(); }
                            doc.setFont('Aileron', 'bold');
                            doc.setFontSize(12);
                            doc.text(headerLines, rightX, rightY);
                            rightY += headerLines.length * 6;

                            if (rightY + descriptionLines.length * 6 > 280) { addNewPage(); }
                            doc.setFont('Aileron', 'normal');
                            doc.setFontSize(10);
                            doc.text(descriptionLines, rightX, rightY);
                            rightY += descriptionLines.length * 6 + 4;
                        });
                    } else {
                        if (rightY + 10 > 280) { addNewPage(); }
                        doc.text('No experience added.', rightX, rightY);
                        rightY += 10;
                    }

                    // Save the document
                    doc.save(`${resume.name}_Resume.pdf`);
                });
            });



            $('#photo-card').on('click', function (event) {
                if (!$(event.target).is('#photo') && !$(event.target).is('#photo-preview')) {
                    $('#photo').trigger('click');
                }
            });

            // Load selected image into Cropper
            $('#photo').on('change', function (e) {
                selectedFile = e.target.files[0];
                if (selectedFile) {
                    const reader = new FileReader();
                    reader.onload = function (event) {
                        $('#image-to-crop').attr('src', event.target.result);
                        $('#cropModal').modal('show');
                    };
                    reader.readAsDataURL(selectedFile);
                }
            });

            // Reset file input to allow re-selection of the same image
            $('#photo').on('click', function () {
                $(this).val('');
            });

            // Initialize Cropper when modal shown
            $('#cropModal').on('shown.bs.modal', function () {
                const image = document.getElementById('image-to-crop');
                cropper = new Cropper(image, {
                    aspectRatio: 1,
                    viewMode: 1,
                    autoCropArea: 1
                });

                // Make the crop modal draggable
                $('.modal-dialog').draggable({
                    handle: '.modal-header',
                    containment: 'window' // Restrict dragging within the window
                });
            });

            // Destroy Cropper on modal hide
            $('#cropModal').on('hidden.bs.modal', function () {
                cropper.destroy();
                cropper = null;
                $('#image-to-crop').attr('src', ''); // Clear the image
            });

            // When user clicks "Crop & Use"
            $('#cropImageBtn').on('click', function () {
                const canvas = cropper.getCroppedCanvas({
                    width: 300,
                    height: 300
                });

                // Convert cropped image to Blob
                canvas.toBlob(function (blob) {
                    croppedBlob = blob;

                    // Set preview and hide placeholder
                    const croppedImageDataURL = URL.createObjectURL(blob);
                    $('#photo-placeholder').addClass('d-none');
                    $('#photo-preview')
                        .attr('src', croppedImageDataURL)
                        .css({ width: '132px', height: '170px' })
                        .removeClass('d-none');

                    // Close modal
                    $('#cropModal').modal('hide');
                }, 'image/png');
            });

            // Ensure the close button properly closes the modal
            $('#closeCropModalBtn').on('click', function () {
                $('#cropModal').modal('hide');
            });

            // Initial fetch
            fetchResumes();
        });
    </script>
</body>

</html>